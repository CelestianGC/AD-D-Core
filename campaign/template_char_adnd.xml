<?xml version="1.0" encoding="iso-8859-1"?>

<!-- 
  Please see the license.html file included with this distribution for 
  attribution and copyright information.
-->

<root>

	<template name="label_savescore">
		<label name="label_save_type">
			<anchored position="righthigh" offset="5,0" width="60" />
			<center />
            <readonly />
			<font>arial-regular-8</font>
			<!-- <frame name="abilityfields" /> -->
		</label>
	</template>
	
	<template name="number_charasavescore">
		<number_savescore>
			<anchored to="statstitle" position="below"/>
			<rollable />
			<script>
				function action(draginfo)
                    local nTargetDC = 20;
                    local rActor = ActorManager.getActor("pc", window.getDatabaseNode());
                    local sActorType, nodeActor = ActorManager.getTypeAndNode(rActor);
                    nTargetDC = DB.getValue(nodeActor, "saves." .. self.target[1] .. ".score", 0);
					ActionSave.performRoll(draginfo, rActor, self.target[1],nTargetDC);
					return true;
				end
				
				function onDragStart(button, x, y, draginfo)
					return action(draginfo);
				end
					
				function onDoubleClick(x,y)
					return action();
				end
			</script>
            
		</number_savescore>
	</template>
	



	<template name="number_labeled">
		<numberfield>
			<font>sheettext</font>
			<lineoffset default="on">1</lineoffset>
			<script>
				labelwidget = nil;
			
				function onInit()
					if labelres then
						labelwidget = addTextWidget("sheetlabelinline", string.upper(Interface.getString(labelres[1])));
					else
						labelwidget = addTextWidget("sheetlabelinline", string.upper(label[1]));
					end
					if labelwidget then
						local w,h = labelwidget.getSize();
						labelwidget.setPosition("bottomleft", w/2, h/2-4);
					end
				end
			</script>
		</numberfield>
	</template>

	<template name="number_charabilityscore2">
		<basicnumber>
 			<anchored to="statstitle" position="insidetopleft"/> 
			<rollable />
            <readonly />
            <min>1</min>
            <max>25</max>
			<default>9</default>
			<font>arial-bold-12</font>
			<frame name="abilityscore_box" />
			<script file="campaign/scripts/number_abilityscore.lua" />
		</basicnumber>
	</template>
    
	<template name="number_saves_modifier">
		<number>
            <anchored position="righthigh" offset="1,0" width="30" height="30"/>
            <displaysign />
			<center />
            <min>-25</min>
            <max>25</max>
			<default>0</default>
			<hideonvalue>0</hideonvalue>
			<font>arial-regular-7</font>
			<frame name="abilityscore_box" /> 
		</number>
	</template>

   	<template name="label_ability_fields">
		<label_fieldtop>
			<anchored offset="-2,-10" />
			<frame name="abilityfields" />
<!-- 			<frame name="abilityscore" /> -->
		</label_fieldtop>
	</template>

   	<template name="label_mod_fields">
		<label_fieldtop>
			<anchored position="below" offset="-2,-10" />
			<frame name="abilityfields" />
<!-- 			<frame name="abilityscore" /> -->
			<font>arial-regular-6</font>
		</label_fieldtop>
	</template>


	<template name="number_abilitypercent_score">
		<numbercontrol>
			<labelres>char_label_ability_percent</labelres>
			<tooltip textres="char_tooltip_percentile" />
            <min>0</min>
            <max>100</max>
			<anchored position="below" offset="-8,-5" />
			<frame name="abilityscore" />
			<font>sheetlabelmini_percent</font>
			<!-- <center /> -->
			<script>
				function onValueChanged()
					local rActor = ActorManager.getActor("pc", window.getDatabaseNode());
					local sActorType, nodeActor = ActorManager.getTypeAndNode(rActor);
					local nScore = DB.getValue(nodeActor, "abilities.strength.score", 0);
					AbilityScores.updateStrength(nodeActor,nScore);
				end
			</script>
		</numbercontrol>
	</template>

	<template name="number_abilitypercent_disabled">
		<number>
			<labelres>char_label_ability_percent</labelres>
			<tooltip textres="char_tooltip_percentile" />
			<anchored position="below" offset="-8,-5" />
			<frame name="abilityscorepercent" />
			<font>sheetlabelmini</font>
			<center />
            <min> 0 </min>
            <max> 100 </max>
			<script>
				function onValueChanged()
					local rActor = ActorManager.getActor("pc", window.getDatabaseNode());
					local sActorType, nodeActor = ActorManager.getTypeAndNode(rActor);
					local nScore = DB.getValue(nodeActor, "abilities.strength.score", 0);
					AbilityScores.updateStrength(nodeActor,nScore);
				end
			</script>
		</number>
	</template>

	<template name="number_abilityfield">
			<number>
				<frame name="abilityscore_box" />
<!--                 <backcolor>#ff99cc</backcolor> -->
				<anchored position="right" offset="0,0" width="40"/>
                <displaysign />
   				<center />
                <nokeyedit />
				<font>regular8</font>
			</number>
	</template>

	<template name="percentile_abilityfield">
			<number>
                <readonly />
				<frame name="abilityscore_box" />
				<anchored position="right" offset="0,0" width="40"/>
   				<center />
				<font>regular8</font>
			</number>
	</template>
	
	<template name="string_abilityfield">
			<stringfield>
				<frame name="abilityscore_box" />
    <!--             <backcolor>#ff99cc</backcolor> -->
				<!-- <multilinespacing>20</multilinespacing> -->
				<anchored position="right" offset="0,0" width="40" />
   				<center />
                <readonly />
				<font>regular8</font>
			</stringfield>
	</template>
	
	<template name="ability_fields_container">
			<frame_char>
				<anchored position="right" offset="0,0" width="280"/>
				<frame name="bonus_box" />
			</frame_char>			
	</template>
	
	<template name="label_npc">
		<stringcontrol>
			<anchored />
			<font>sheetlabel</font>
			<nodrag />
			<readonly />
		</stringcontrol>
	</template>

	<template name="cycler_skill_type">
		<button_stringcycler>
			<parameters>
				<defaultlabelres mergerule="replace">dash</defaultlabelres>
				<labelsres>str|dex|con|int|wis|cha|percent</labelsres>
				<values>strength|dexterity|constitution|intelligence|wisdom|charisma|percent</values>
			</parameters>
		</button_stringcycler>
	</template>
    <template name="number_charskill_nosign">
        <basicnumber>
            <anchored width="32" height="20" />
            <delaykeyupdate />
            <hideonvalue>0</hideonvalue>
            <nodrag />
        </basicnumber>
    </template>
	<template name="number_charskilltotal_nosign">
		<number_linked>
			<anchored width="32" height="20" />
			<frame name="fieldlight" offset="7,5,7,5" />
			<rollable />
            <script file="campaign/scripts/number_charskill.lua" />
		</number_linked>
	</template>
    
	<template name="number_charthaco">
		<basicnumber>
            <min>-10</min>
            <max>30</max>
            <default>20</default>
			<font>reference-b-large</font>
		</basicnumber>
	</template>

	<template name="label_skill">
		<stringcontrol>
			<anchored />
			<font>sheetlabel</font>
			<nodrag />
			<readonly />
		</stringcontrol>
	</template>

	<template name="label_fieldbottom">
		<stringcontrol>
			<anchored position="below" offset="3,1" />
			<font>sheetlabelmini</font>
			<center />
		</stringcontrol>
	</template>
    
	<template name="number_actions_init">
        <basicnumber>
			<frame name="fieldlight" offset="7,5,7,5" />
			<showemptywidget />
			<font>arial-regular-8</font>
			<hideonvalue>0</hideonvalue>
			<rollable />
			<displaysign />
			<script>
				function action(draginfo)
                    local nValue = getValue();

                    local rItem = {};
                    rItem.sName = window.name.getValue();
                    rItem.nInit = nValue;
                    local nodeWeapon = getDatabaseNode();
                    local nodeChar = nodeWeapon.getChild("....");
					local rActor = ActorManager.getActor("pc", nodeChar);
					ActionInit.performRoll(draginfo, rActor, nil, rItem);

					return true;
				end
				
				function onDragStart(button, x, y, draginfo)
					return action(draginfo);
				end
					
				function onDoubleClick(x,y)
					return action();
				end
			</script>
        </basicnumber>
	</template>
	<template name="number_power_init">
        <basicnumber>
			<frame name="fieldlight" offset="7,5,7,5" />
			<showemptywidget />
			<font>arial-regular-8</font>
			<rollable />
			<displaysign />
			<hideonvalue>0</hideonvalue>
			<script>
				function action(draginfo)
                    local nValue = getValue();
                    local nodePower = getDatabaseNode();
                    local nodeSpell = nodePower.getChild("....");
                    local sName = DB.getValue(nodeSpell,"name","");
                
                    local rItem = {};
                    rItem.sName = sName;
                    rItem.nInit = nValue;
                    local nodeChar = nodePower.getChild("......");
					local rActor = ActorManager.getActor("pc", nodeChar);
					ActionInit.performRoll(draginfo, rActor, nil, rItem);

					return true;
				end
				
				function onDragStart(button, x, y, draginfo)
					return action(draginfo);
				end
					
				function onDoubleClick(x,y)
					return action();
				end
			</script>
        </basicnumber>
	</template>

	<template name="button_charabiltiesdetail">
		<buttoncontrol>
			<anchored width="20" height="20" />
			<state icon="details" pressed="details_down" />
			<script>
				function onButtonPress()
					Interface.openWindow("charsheet_abilities_details", window.getDatabaseNode());
				end
			</script>
		</buttoncontrol>
	</template>
	<template name="button_charasavesdetail">
		<buttoncontrol>
			<anchored width="20" height="20" />
			<state icon="details" pressed="details_down" />
			<script>
				function onButtonPress()
					Interface.openWindow("charsheet_saves_details", window.getDatabaseNode());
				end
			</script>
		</buttoncontrol>
	</template>
    
    <template name="label_plus">
            <label>
				<anchored>
					<top  />
					<left anchor="right" relation="relative" offset="5" />
				</anchored>
                <static text="+"/>
            </label>
    </template>
    <template name="ability_number_base">
            <basicnumber>
				<anchored width="30" height="20">
					<top  />
					<left anchor="right" relation="relative" offset="10" />
				</anchored>
                <frame name="fielddark" offset="7,5,7,5" />
                <stateframe>
                    <hover name="rowshade" offset="7,5,7,5" />
                </stateframe>
                <cursor hover="hand" />
                <font>arial-bold-8</font>
                <default>9</default>
                <hideonvalue>0</hideonvalue>
                <min>0</min>
                <max>25</max>
            </basicnumber>
    
    </template>
    <template name="ability_percent_number_base">
            <basicnumber>
				<anchored width="30" height="20">
					<top  />
					<left anchor="right" relation="relative" offset="10" />
				</anchored>
                <frame name="fielddark" offset="7,5,7,5" />
                <stateframe>
                    <hover name="rowshade" offset="7,5,7,5" />
                </stateframe>
                <cursor hover="hand" />
                <font>arial-bold-8</font>
                <default>0</default>
                <hideonvalue>0</hideonvalue>
                <min>0</min>
                <max>100</max>
            </basicnumber>
    
    </template>
    <template name="ability_number_mod">
            <basicnumber>
				<anchored width="30" height="20">
					<top  />
					<left anchor="right" relation="relative" offset="5" />
				</anchored>
                <frame name="fielddark" offset="7,5,7,5" />
                <stateframe>
                    <hover name="rowshade" offset="7,5,7,5" />
                </stateframe>
                <cursor hover="hand" />
                <font>arial-regular-8</font>
                <hideonvalue>0</hideonvalue>
                <default>0</default>
                <displaysign />
            </basicnumber>
    </template>
    <template name="ability_details_total">
            <basicnumber>
       			<script file="campaign/scripts/char_abilities_details.lua" />
                <script>
                    function onInit()
                        super.onInit();
                        local nodeChar = window.getDatabaseNode();
                        local sTarget = string.lower(self.target[1]);
                        DB.addHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".base"),       "onUpdate", detailsUpdate);
                        DB.addHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".basemod"),    "onUpdate", detailsUpdate);
                        DB.addHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".itemmod"),    "onUpdate", detailsUpdate);
                        DB.addHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".effectmod"),  "onUpdate", detailsUpdate);
                        DB.addHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".adjustment"), "onUpdate", detailsUpdate);
                        DB.addHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".tempmod"),    "onUpdate", detailsUpdate);
                        detailsUpdate();
                    end
                    
                    function onClose()
                        local nodeChar = window.getDatabaseNode();
                        local sTarget = string.lower(self.target[1]);
                        DB.removeHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".base"),       "onUpdate", detailsUpdate);
                        DB.removeHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".basemod"),    "onUpdate", detailsUpdate);
                        DB.removeHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".itemmod"),    "onUpdate", detailsUpdate);
                        DB.removeHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".effectmod"),  "onUpdate", detailsUpdate);
                        DB.removeHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".adjustment"), "onUpdate", detailsUpdate);
                        DB.removeHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".tempmod"),    "onUpdate", detailsUpdate);
                    end
                    
                </script>
                <anchored width="30" height="20">
                    <top  />
                    <left anchor="right" relation="relative" offset="10" />
                </anchored>
                <frame name="fielddark" offset="7,5,7,5" />
                <stateframe>
                    <hover name="rowshade" offset="7,5,7,5" />
                </stateframe>
                <cursor hover="hand" />
                <readonly />
                <font>arial-bold-8</font>
                <readonly />
                <hideonvalue>0</hideonvalue>
            </basicnumber>
    </template>
    <template name="ability_details_percent_total" >
            <basicnumber>
       			<script file="campaign/scripts/char_abilities_details.lua" />
                <script>
                    function onInit()
                        super.onInit();
                        local nodeChar = window.getDatabaseNode();
                        local sTarget = string.lower(self.target[1]);
                        
                        DB.addHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".percentbase"),      "onUpdate", detailsPercentUpdate);
                        DB.addHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".percentbasemod"),   "onUpdate", detailsPercentUpdate);
                        DB.addHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".percentitemmod"),   "onUpdate", detailsPercentUpdate);
                        DB.addHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".percenteffectmod"), "onUpdate", detailsPercentUpdate);
                        DB.addHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".percentadjustment"),"onUpdate", detailsPercentUpdate);
                        DB.addHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".percenttempmod"),   "onUpdate", detailsPercentUpdate);
                        detailsPercentUpdate();
                    end
                    
                    function onClose()
                        local nodeChar = window.getDatabaseNode();
                        local sTarget = string.lower(self.target[1]);

                        DB.removeHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".percentbase"),       "onUpdate", detailsPercentUpdate);
                        DB.removeHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".percentbasemod"),    "onUpdate", detailsPercentUpdate);
                        DB.removeHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".percentitemmod"),    "onUpdate", detailsPercentUpdate);
                        DB.removeHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".percenteffectmod"),  "onUpdate", detailsPercentUpdate);
                        DB.removeHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".percentadjustment"), "onUpdate", detailsPercentUpdate);
                        DB.removeHandler(DB.getPath(nodeChar, "abilities." .. sTarget .. ".percenttempmod"),    "onUpdate", detailsPercentUpdate);
                    end
                    
                </script>
                <anchored width="30" height="20">
                    <top  />
                    <left anchor="right" relation="relative" offset="10" />
                </anchored>
                <frame name="fielddark" offset="7,5,7,5" />
                <stateframe>
                    <hover name="rowshade" offset="7,5,7,5" />
                </stateframe>
                <cursor hover="hand" />
                <readonly />
                <font>arial-bold-8</font>
                <readonly />
                <hideonvalue>0</hideonvalue>
            </basicnumber>
    </template>
    
    <template name="label_ability_details_stat">
            <label>
                <center />
   				<backcolor>#afaf83</backcolor>
				<anchored to="leftanchor" width="75">
					<top relation="relative"/>
 					<left anchor="right" offset="70"/>
				</anchored>
            </label>
    </template>
    <template name="label_ability_details">
            <label>
                <center />
				<anchored to="leftanchor"  width="75">
					<top relation="relative" />
					<left anchor="right" offset="70"/>
				</anchored>
            </label>
    </template>

	<template name="number_char_save">
		<basicnumber>
                <frame name="fielddark" offset="7,5,7,5" />
                <stateframe>
                    <hover name="rowshade" offset="7,5,7,5" />
                </stateframe>
                <cursor hover="hand" />
			<default>20</default>
			<anchored to="statstitle" position="below"/>
			<rollable />
            <readonly />
   			<script file="campaign/scripts/char_saves_details.lua" />
		</basicnumber>
	</template>

    <template name="label_save_details">
            <label>
                <center />
				<anchored to="leftanchor"  width="75">
					<top relation="relative" />
					<left anchor="right" offset="55"/>
				</anchored>
            </label>
    </template>
    <template name="save_details_total">
            <basicnumber>
                <anchored width="30" height="20">
                    <top  />
                    <left anchor="right" relation="relative" offset="10" />
                </anchored>
                <frame name="fielddark" offset="7,5,7,5" />
                <stateframe>
                    <hover name="rowshade" offset="7,5,7,5" />
                </stateframe>
                <cursor hover="hand" />
                <readonly />
                <font>arial-bold-8</font>
                <readonly />
                <hideonvalue>0</hideonvalue>
            </basicnumber>
    </template>
    <template name="save_number_base">
            <basicnumber>
				<anchored width="30" height="20">
					<top  />
					<left anchor="right" relation="relative" offset="10" />
				</anchored>
                <frame name="fielddark" offset="7,5,7,5" />
                <stateframe>
                    <hover name="rowshade" offset="7,5,7,5" />
                </stateframe>
                <cursor hover="hand" />
                <font>arial-bold-8</font>
                <default>20</default>
                <hideonvalue>0</hideonvalue>
                <min>0</min>
                <max>25</max>
            </basicnumber>
    
    </template>
    <template name="save_number_mod">
            <basicnumber>
				<anchored width="30" height="20">
					<top  />
					<left anchor="right" relation="relative" offset="5" />
				</anchored>
                <frame name="fielddark" offset="7,5,7,5" />
                <stateframe>
                    <hover name="rowshade" offset="7,5,7,5" />
                </stateframe>
                <cursor hover="hand" />
                <font>arial-regular-8</font>
                <hideonvalue>0</hideonvalue>
                <default>0</default>
                <displaysign />
            </basicnumber>
    </template>
    
    <template name="char_speed_details">
			<basicnumber name="speedbase" source="speed.base">
				<default>12</default>
                <script>
                    function onInit()
                        onUpdate();
                    end
                    function onUpdate()
                        local node = getDatabaseNode();
                        local nodeChar = node.getChild("...");
                        DB.setValue(nodeChar,"speed.total","number",getValue());
                    end
                </script>
			</basicnumber>
    </template>

	<template name="class_cycler_do_as">
		<button_stringcycler>
			<parameters>
				<labelsres>warrior|priest|wizard|rogue</labelsres>
				<values>warrior|priest|wizard|rogue</values>
			</parameters>
		</button_stringcycler>
	</template>
    
    <template name="number_adjustment">
			<basicnumber>
            <anchored width="20" height="15"/>
                <default>0</default>
                <displaysign />
				<hideonvalue>0</hideonvalue>
			</basicnumber>
    </template>
    </root>
